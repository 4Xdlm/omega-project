name: OMEGA Phase 12 Certify

on:
  push:
    branches: [ "master" ]
    tags:
      - "v3.12.*"
  workflow_dispatch:

jobs:
  certify:
    runs-on: windows-latest

    defaults:
      run:
        working-directory: OMEGA_PHASE12

    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0  # Required for git diff vs Phase 11 tag

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: "20"

      - name: Install Dependencies
        run: npm install

      - name: Run Tests (npm/vitest)
        run: npm test

      - name: Install Pester (latest)
        shell: pwsh
        working-directory: .
        run: |
          Install-Module Pester -Force -Scope CurrentUser -MinimumVersion 5.0
          Import-Module Pester
          Get-Module Pester -ListAvailable | Select-Object -First 1

      - name: Run Tests (Pester)
        shell: pwsh
        working-directory: .
        run: |
          $config = New-PesterConfiguration
          $config.Run.Path = "OMEGA_PHASE12/deployment/tests"
          $config.Output.Verbosity = "Detailed"
          Invoke-Pester -Configuration $config

      - name: Generate Evidence Pack
        shell: pwsh
        working-directory: .
        run: |
          powershell -ExecutionPolicy Bypass -File .\OMEGA_PHASE12\deployment\scripts\evidence_pack.ps1

      - name: Verify Deployment
        shell: pwsh
        working-directory: .
        run: |
          powershell -ExecutionPolicy Bypass -File .\OMEGA_PHASE12\deployment\scripts\omega_verify.ps1

      - name: Double-Run Merkle Stability Check
        shell: pwsh
        working-directory: .
        run: |
          # Run 1
          node .\OMEGA_PHASE12\deployment\scripts\merkle_manifest.node.mjs
          $root1 = Get-Content .\evidence\PHASE_12_EVIDENCE\manifest.root.sha256 -Raw
          $root1 = $root1.Trim()
          
          # Run 2
          node .\OMEGA_PHASE12\deployment\scripts\merkle_manifest.node.mjs
          $root2 = Get-Content .\evidence\PHASE_12_EVIDENCE\manifest.root.sha256 -Raw
          $root2 = $root2.Trim()
          
          # Save both roots for audit
          $root1 | Out-File -FilePath .\evidence\PHASE_12_EVIDENCE\merkle_root_run1.txt -Encoding utf8
          $root2 | Out-File -FilePath .\evidence\PHASE_12_EVIDENCE\merkle_root_run2.txt -Encoding utf8
          
          # Verify stability
          Write-Host "RUN 1: $root1"
          Write-Host "RUN 2: $root2"
          
          if ($root1 -ne $root2) {
            Write-Error "MERKLE ROOT NOT STABLE!"
            exit 1
          }
          
          Write-Host "MERKLE STABLE: TRUE" -ForegroundColor Green

      - name: Record CI Run ID
        shell: pwsh
        working-directory: .
        run: |
          $ciInfo = @"
          OMEGA PHASE 12 - CI/CD RUN RECORD
          ==================================
          Run ID: ${{ github.run_id }}
          Run Number: ${{ github.run_number }}
          Commit: ${{ github.sha }}
          Branch: ${{ github.ref_name }}
          Actor: ${{ github.actor }}
          Timestamp: $(Get-Date -Format "o")
          Repository: ${{ github.repository }}
          Workflow: ${{ github.workflow }}
          "@
          $ciInfo | Out-File -FilePath .\evidence\PHASE_12_EVIDENCE\ci_run_info.txt -Encoding utf8
          Write-Host $ciInfo

      - name: Upload Evidence Pack
        uses: actions/upload-artifact@v4
        with:
          name: PHASE_12_EVIDENCE
          path: evidence/PHASE_12_EVIDENCE/**
          retention-days: 90

      - name: Upload Replay Pack (if exists)
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: PHASE_12_REPLAY
          path: evidence/PHASE_12_REPLAY.zip
          if-no-files-found: ignore
          retention-days: 90
