# ═══════════════════════════════════════════════════════════════════════════════════════════
# OMEGA POLICY v8.0 TITANIUM ULTIME
# Machine-readable — Source of Truth for Policy Engine
# ═══════════════════════════════════════════════════════════════════════════════════════════

omegafile: "OMEGA_POLICY"
version: "8.0"
edition: "TITANIUM_ULTIME"
standard:
  - "NASA-Grade L4"
  - "DO-178C Level A"
  - "MIL-STD"

# ═══════════════════════════════════════════════════════════════════════════════════════════
# REPOSITORY CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════════════════

repo:
  default_branch: "master"
  remote: "origin"
  version_prefix: "v3"  # Rester en v3.xx.0 jusqu'à vraie bascule major

# ═══════════════════════════════════════════════════════════════════════════════════════════
# SANCTUARIES (READ-ONLY ABSOLUTE)
# ═══════════════════════════════════════════════════════════════════════════════════════════

sanctuaries:
  - "OMEGA_SENTINEL_SUPREME/**"
  - "packages/sentinel/**"
  - "packages/genome/**"
  - "packages/mycelium/**"
  - "packages/nexus/**"  # Si sanctuarisé

sanctuary_base_tag: "v3.31.0"

# ═══════════════════════════════════════════════════════════════════════════════════════════
# NEXUS DEP — EMPLACEMENT OFFICIEL
# ═══════════════════════════════════════════════════════════════════════════════════════════

nexus_dep:
  package: "packages/integration-nexus-dep"
  role: "Bus connexions + traduction + router + in/out"
  rule: "NE JAMAIS modifier les sanctuaires, uniquement CONSOMMER"
  structure:
    - "src/contracts/"
    - "src/adapters/"
    - "src/router/"
    - "test/"

# ═══════════════════════════════════════════════════════════════════════════════════════════
# COMMANDS CLASSIFICATION
# ═══════════════════════════════════════════════════════════════════════════════════════════

commands:

  # ─────────────────────────────────────────────────────────────────────────────────────────
  # SAFE EXACT - Commandes exactes toujours autorisées
  # ─────────────────────────────────────────────────────────────────────────────────────────
  safe_exact:
    # Git read-only
    - "git status"
    - "git status --short"
    - "git status -s"
    - "git diff"
    - "git diff --name-only"
    - "git diff --cached"
    - "git diff --cached --name-only"
    - "git diff HEAD"
    - "git log"
    - "git log -1"
    - "git log --oneline"
    - "git log --oneline -10"
    - "git show"
    - "git show HEAD"
    - "git describe"
    - "git describe --tags"
    - "git describe --tags --abbrev=0"
    - "git rev-parse HEAD"
    - "git rev-parse --short HEAD"
    - "git branch"
    - "git branch -a"
    - "git branch -v"
    - "git remote -v"
    - "git tag -l"
    - "git tag --list"
    - "git fetch"
    
    # Filesystem read
    - "pwd"
    - "ls"
    - "ls -la"
    - "ls -lah"
    - "dir"
    - "tree"
    - "cat"
    - "type"
    - "head"
    - "tail"
    - "more"
    - "less"
    - "wc"
    - "wc -l"
    
    # Hash
    - "sha256sum"
    - "shasum -a 256"
    - "md5sum"
    - "openssl dgst -sha256"
    
    # System info
    - "date"
    - "hostname"
    - "whoami"
    - "which"
    - "where"
    - "env"
    - "printenv"
    - "node --version"
    - "npm --version"
    
    # Node/NPM safe
    - "npm test"
    - "npm run test"
    - "npm run build"
    - "npm run lint"
    - "npm run format"
    - "npm ls"
    - "npm list"
    - "zip --version"

  # ─────────────────────────────────────────────────────────────────────────────────────────
  # SAFE PREFIX - Commandes autorisées si commencent par...
  # ─────────────────────────────────────────────────────────────────────────────────────────
  safe_prefix:
    # Filesystem creation/copy/move
    - "mkdir"
    - "mkdir -p"
    - "New-Item -ItemType Directory"
    - "New-Item"
    - "touch"
    - "cp "
    - "copy "
    - "Copy-Item"
    - "mv "
    - "move "
    - "Move-Item"
    - "Get-ChildItem"
    
    # Archives
    - "zip "
    - "zip -r"
    - "unzip"
    - "tar "
    - "tar -c"
    - "tar -x"
    - "tar --"
    - "Compress-Archive"
    - "Expand-Archive"
    - "7z "
    
    # Text processing
    - "grep"
    - "find "
    - "diff "
    - "tee "
    - "sort "
    - "uniq "
    - "cut "
    - "tr "
    - "awk "
    - "sed "
    
    # Hash
    - "Get-FileHash"
    - "sha256sum "
    - "shasum "
    
    # Echo/Output
    - "echo "
    - "printf "
    - "Write-Output"
    
    # Variables bash et chaînage
    - "TIMESTAMP="
    - "COMMIT="
    - "TAG="
    - "date +"
    - "$(date"
    - "$(git rev-parse"
    - "$(git describe"
    
    # Node/NPM variants
    - "npm run test:"
    - "npm run "
    - "npx vitest"
    - "npx jest"
    - "node "
    
    # Git write SAFE (staging contrôlé explicite)
    - "git add certificates/"
    - "git add evidence/"
    - "git add history/"
    - "git add packages/integration-nexus-dep/"
    - "git add docs/"
    - "git add README"
    - "git commit "
    - "git commit -m"
    - "git commit --dry-run"
    - "git tag -a "
    - "git push origin master"
    - "git push --dry-run"
    - "git checkout -- "
    - "git restore "

  # ─────────────────────────────────────────────────────────────────────────────────────────
  # SAFE PRE-FLIGHT ONLY
  # ─────────────────────────────────────────────────────────────────────────────────────────
  safe_preflight_only:
    - "npm install"
    - "npm ci"
    - "npm update"

  # ─────────────────────────────────────────────────────────────────────────────────────────
  # FORBIDDEN ABSOLUTE (DENY_CRITICAL)
  # ─────────────────────────────────────────────────────────────────────────────────────────
  forbidden_prefix:
    # Suppression
    - "rm "
    - "rm -"
    - "rmdir"
    - "del "
    - "del /"
    - "Remove-Item"
    - "unlink"
    
    # Git destructif
    - "git reset"
    - "git clean"
    - "git push --force"
    - "git push -f"
    - "git rebase"
    - "git filter-branch"
    - "git reflog expire"
    - "git gc --prune"
    
    # Git merge/pull/stash (TOUJOURS interdit — merge implicite)
    - "git pull"
    - "git merge"
    - "git stash"
    
    # Git tag destructif
    - "git tag -d"
    - "git push --delete"
    - "git push origin :"
    
    # Staging global (TOUJOURS interdit)
    - "git add -A"
    - "git add ."
    - "git add --all"
    
    # Système privilégié
    - "sudo "
    - "chmod "
    - "chown "
    - "format "
    - "fdisk "
    - "mkfs"

  # ─────────────────────────────────────────────────────────────────────────────────────────
  # FORBIDDEN IN GOLD MASTER (Phase 60)
  # ─────────────────────────────────────────────────────────────────────────────────────────
  forbidden_gold_master:
    - "npm install"
    - "npm ci"
    - "npm update"
    - "git fetch"
    - "git pull"

# ═══════════════════════════════════════════════════════════════════════════════════════════
# UNKNOWN COMMAND POLICY
# ═══════════════════════════════════════════════════════════════════════════════════════════

unknown_policy:
  deny_if_contains:
    - "git "
    - "npm "
    - "curl "
    - "wget "
    - "Invoke-WebRequest"
    - "Invoke-RestMethod"
    - "Start-BitsTransfer"
    - "> "
    - ">> "
    - "Out-File"
    - "Set-Content"
    - "Add-Content"
    - "| "
    - "http://"
    - "https://"
  
  deny_critical_if_contains:
    - "sudo"
    - "admin"
    - "root"
    - "passwd"
    - "shadow"
    - "/etc/"
    - "C:\\Windows\\System32"
  
  default: "DENY"

# ═══════════════════════════════════════════════════════════════════════════════════════════
# COMMAND COMPOSITION RULES
# ═══════════════════════════════════════════════════════════════════════════════════════════

composition_rules:
  # Chaînage && : autorisé si CHAQUE segment est SAFE
  chain_and:
    enabled: true
    separator: "&&"
    rule: "ALL_SAFE"
  
  # Chaînage ; : même règle
  chain_semicolon:
    enabled: true
    separator: ";"
    rule: "ALL_SAFE"
  
  # Pipe | : exceptions pour commandes lecture seule
  pipe:
    enabled: true
    default: "DENY"
    exceptions:
      - "| tee "
      - "| grep "
      - "| head "
      - "| tail "
      - "| wc "
      - "| sort"
      - "| uniq"

# ═══════════════════════════════════════════════════════════════════════════════════════════
# SUBSTITUTION WHITELIST — $(...) autorisé UNIQUEMENT pour ces commandes
# ═══════════════════════════════════════════════════════════════════════════════════════════

substitution_safe:
  # Git
  - "git rev-parse HEAD"
  - "git rev-parse --short HEAD"
  - "git describe --tags"
  - "git describe --tags --abbrev=0"
  - "git branch --show-current"
  
  # Date/Time
  - "date"
  - "date +%Y%m%d"
  - "date +%Y%m%d_%H%M"
  - "date +%Y-%m-%d"
  - "date +%H%M%S"
  - "date -u"
  
  # Info système (lecture seule)
  - "pwd"
  - "whoami"
  - "hostname"

# ═══════════════════════════════════════════════════════════════════════════════════════════
# TAR RULES
# ═══════════════════════════════════════════════════════════════════════════════════════════

tar_rules:
  # Création = SAFE
  safe_create:
    - "tar -c"
    - "tar -cz"
    - "tar -czf"
    - "tar -czvf"
    - "tar --create"
  
  # Liste = SAFE (lecture seule)
  safe_list:
    - "tar -t"
    - "tar -tf"
    - "tar -tzvf"
    - "tar --list"
  
  # Extraction = DENY sauf avec -C
  extract_without_destination: "DENY"
  extract_with_destination: "ALLOW"
  destination_flag: "-C"

# ═══════════════════════════════════════════════════════════════════════════════════════════
# VOCABULARY (LOCKED)
# ═══════════════════════════════════════════════════════════════════════════════════════════

vocabulary:
  certified: "CERTIFIED"
  rejected: "REJECTED"
  push_pending: "PUSH PENDING"
  gold: "GOLD"
  
  forbidden_terms:
    - "CERTIFIED LOCAL"
    - "PARTIALLY CERTIFIED"
    - "ALMOST CERTIFIED"
    - "CERTIFIED WITH ISSUES"

# ═══════════════════════════════════════════════════════════════════════════════════════════
# PHASE REQUIREMENTS
# ═══════════════════════════════════════════════════════════════════════════════════════════

phase_requirements:
  required_files:
    - "certificates/{phase}/DESIGN_PHASE_{phase_upper}.md"
    - "certificates/{phase}/CERT_PHASE_{phase_upper}.md"
    - "certificates/{phase}/CERT_SCOPE_PHASE_{phase_upper}.txt"
    - "certificates/{phase}/HASHES_PHASE_{phase_upper}.sha256"
    - "certificates/{phase}/PHASE_{phase_upper}_FROZEN.md"
    - "evidence/{phase}/tests.log"
    - "evidence/{phase}/commands.txt"
    - "history/HISTORY_PHASE_{phase_upper}.md"
  
  zip_required: true
  zip_path_pattern: "archives/{phase}/"
  zip_name_pattern: "OMEGA_PHASE_{phase_upper}_*.zip"

# ═══════════════════════════════════════════════════════════════════════════════════════════
# PHASE PLAN (40 → 60 avec NEXUS DEP)
# ═══════════════════════════════════════════════════════════════════════════════════════════

phase_plan:
  version_scheme: "v3.XX.0"  # Monotone cohérent
  
  phases:
    # BLOC A — CONSOLIDATION + NEXUS DEP BOOTSTRAP (40-45)
    - id: "phase40_0"
      name: "Consolidation"
      objective: "Consolidation globale sans refactor cosmétique"
      version: "v3.40.0"
    
    - id: "phase41_0"
      name: "Nexus DEP Bootstrap"
      objective: "packages/integration-nexus-dep/ - contracts, types, tests base"
      version: "v3.41.0"
      creates: "packages/integration-nexus-dep/"
    
    - id: "phase42_0"
      name: "Nexus DEP Router"
      objective: "Dispatch + registry + handlers fake"
      version: "v3.42.0"
    
    - id: "phase43_0"
      name: "Nexus DEP Translators"
      objective: "In/out normalisation + json stable"
      version: "v3.43.0"
    
    - id: "phase44_0"
      name: "Nexus DEP Adapters"
      objective: "Adapters filesystem/cli mock, lecture sanctuaires"
      version: "v3.44.0"
    
    - id: "phase45_0"
      name: "Nexus DEP Integration"
      objective: "Integration tests monorepo + e2e minimal"
      version: "v3.45.0"
    
    # BLOC B — HARDENING (46-49)
    - id: "phase46_0"
      name: "Hardening Inputs"
      objective: "Rejets bytes interdits, sanitation"
      version: "v3.46.0"
    
    - id: "phase47_0"
      name: "Determinism Proof"
      objective: "2 runs identiques, compare outputs"
      version: "v3.47.0"
    
    - id: "phase48_0"
      name: "Performance"
      objective: "Benchmarks contractuels"
      version: "v3.48.0"
    
    - id: "phase49_0"
      name: "Red Team"
      objective: "Audit hostile surfaces d'entrée"
      version: "v3.49.0"
    
    # BLOC C — VALIDATION (50-54)
    - id: "phase50_0"
      name: "E2E Pipeline"
      objective: "Validation complète pipeline"
      version: "v3.50.0"
    
    - id: "phase51_0"
      name: "Cross-Platform"
      objective: "Validation cross-platform"
      version: "v3.51.0"
    
    - id: "phase52_0"
      name: "Stress Tests"
      objective: "Tests extrêmes"
      version: "v3.52.0"
    
    - id: "phase53_0"
      name: "Determinism 100 Runs"
      objective: "Validation déterminisme échantillon"
      version: "v3.53.0"
    
    - id: "phase54_0"
      name: "External Audit"
      objective: "Audit externe simulé, pack preuves"
      version: "v3.54.0"
    
    # BLOC D — PRE-RELEASE (55-59)
    - id: "phase55_0"
      name: "Documentation"
      objective: "docs/ complète, zéro code"
      version: "v3.55.0"
    
    - id: "phase56_0"
      name: "Release Notes"
      objective: "Changelog complet"
      version: "v3.56.0"
    
    - id: "phase57_0"
      name: "Triple Validation"
      objective: "3 runs tests"
      version: "v3.57.0"
    
    - id: "phase58_0"
      name: "Pre-GOLD Audit"
      objective: "Zéro dette"
      version: "v3.58.0"
    
    - id: "phase59_0"
      name: "GOLD Rehearsal"
      objective: "Simulation freeze"
      version: "v3.59.0"
    
    # BLOC E — GOLD MASTER
    - id: "phase60_0"
      name: "GOLD MASTER"
      objective: "Freeze total"
      version: "v3.60.0-GOLD"
      is_gold: true

# ═══════════════════════════════════════════════════════════════════════════════════════════
# GOLD MASTER CONFIGURATION (Phase 60)
# ═══════════════════════════════════════════════════════════════════════════════════════════

gold_master:
  phase: "phase60_0"
  phase_upper: "PHASE60_0"
  
  required_zips:
    - name_contains: "OMEGA_GOLD_MASTER_FULL"
    - name_contains: "OMEGA_GOLD_MASTER_DOCS"
    - name_contains: "OMEGA_GOLD_MASTER_SOURCE"
  
  required_files:
    - "certificates/phase60_0/CERT_PHASE60_GOLD_MASTER.md"
    - "certificates/phase60_0/CERT_SCOPE_PHASE60.txt"
    - "certificates/phase60_0/HASHES_PHASE60.sha256"
    - "certificates/phase60_0/PHASE60_GOLD_FROZEN.md"
    - "history/FINAL_REPORT_PHASE60_GOLD_MASTER.md"
  
  final_tag: "v3.60.0-GOLD"
  
  forbid_after_gold:
    - "git commit"
    - "git tag"
    - "git push"
    - "npm install"
    - "npm ci"

# ═══════════════════════════════════════════════════════════════════════════════════════════
# NCR CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════════════════

ncr:
  log_file: "history/NCR_LOG.md"
  append_only: true
  
  severity_levels:
    - "LOW"
    - "MEDIUM"
    - "HIGH"
    - "CRITICAL"
  
  auto_create_on:
    - "DENY"
    - "DENY_CRITICAL"
    - "test_blocking_fail"
    - "sanctuary_modified"
    - "artifact_missing"

# ═══════════════════════════════════════════════════════════════════════════════════════════
# PUSH PENDING CONFIGURATION
# ═══════════════════════════════════════════════════════════════════════════════════════════

push_pending:
  enabled: true
  log_file: "history/PUSH_PENDING.md"
  append_only: true
  retry_on_next_preflight: true
  max_retries: 5

# ═══════════════════════════════════════════════════════════════════════════════════════════
# DECISION RULES
# ═══════════════════════════════════════════════════════════════════════════════════════════

decision_rules:
  evaluation_order:
    - "check_forbidden"
    - "check_safe_exact"
    - "check_safe_prefix"
    - "check_unknown_deny_patterns"
    - "check_unknown_critical_patterns"
    - "apply_default"
  
  actions:
    ALLOW:
      exit_code: 0
      execute: true
      log: false
    DENY:
      exit_code: 2
      execute: false
      log: true
      create_ncr: true
      ncr_severity: "MEDIUM"
    DENY_CRITICAL:
      exit_code: 3
      execute: false
      log: true
      create_ncr: true
      ncr_severity: "CRITICAL"

# ═══════════════════════════════════════════════════════════════════════════════════════════
# END OF POLICY v8.0 TITANIUM ULTIME
# ═══════════════════════════════════════════════════════════════════════════════════════════
