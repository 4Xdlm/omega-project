# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#
#    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ–ˆâ•—   â–ˆâ–ˆâ•—    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
#   â–ˆâ–ˆâ•”â•â•â•â•â• â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â•â•â•â–ˆâ–ˆâ•—â–ˆâ–ˆâ–ˆâ–ˆâ•—  â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•”â•â•â•â•â•
#   â–ˆâ–ˆâ•‘      â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•”â–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—  
#   â–ˆâ–ˆâ•‘      â–ˆâ–ˆâ•”â•â•â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘   â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ•—â–ˆâ–ˆâ•‘    â–ˆâ–ˆâ•”â•â•â•  
#   â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•— â–ˆâ–ˆâ•‘  â–ˆâ–ˆâ•‘â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘â•šâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•”â•â–ˆâ–ˆâ•‘ â•šâ–ˆâ–ˆâ–ˆâ–ˆâ•‘    â–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ–ˆâ•—
#    â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•šâ•â•  â•šâ•â•â•â• â•šâ•â•â•â•â•â• â•šâ•â•  â•šâ•â•â•â•    â•šâ•â•â•â•â•â•â•
#
#   OMEGA â€” PROMPT D'EXÃ‰CUTION AUTONOME CLAUDE CODE
#   PHASE E â€” CANON SCHEMA & PERSISTENCE
#
#   Version: 1.2.0 FINAL
#   Date: 2026-01-28
#   Standard: NASA-Grade L4 / DO-178C / MIL-STD
#
#   CHANGELOG v1.1 â†’ v1.2:
#   - Ajout rÃ¨gle INT-E-07 explicite (interdit !== pour sÃ©mantique)
#   - Ajout test golden semanticEquals avec bigint
#   - Ajout test containsNaN rÃ©cursif explicite
#   - Suppression prÃ©dicat SUPERSEDES du catalog (double source Ã©vitÃ©e)
#   - Ajout section audit prod 100M claims
#   - DÃ©tail complet tests Golden
#
#   DÃ‰PENDANCES:
#   - Phase C+D SEALED (Tag: OMEGA_INTEGRATION_PHASE_CD_v1.0_SEALED)
#   - CANON_SCHEMA_SPEC v1.2.0 (SHA-256: 6a6298aed6e50ad86d119a4e876d9119838d65d994a0ba3162cc7a5919eaeac2)
#
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

---

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                    PARTIE 0 â€” MODE D'EXÃ‰CUTION FERMÃ‰
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## Â§0.1 DÃ‰CLARATION COGNITIVE (NON NÃ‰GOCIABLE)

```
â•”â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•—
â•‘                                                                                                       â•‘
â•‘   TU ES UN MOTEUR D'EXÃ‰CUTION DÃ‰TERMINISTE.                                                           â•‘
â•‘   TU N'ES PAS UN INTERPRÃˆTE.                                                                          â•‘
â•‘   TU N'ES PAS UN CONSEILLER.                                                                          â•‘
â•‘   TU N'ES PAS UN ASSISTANT.                                                                           â•‘
â•‘                                                                                                       â•‘
â•‘   RÃˆGLES ABSOLUES:                                                                                    â•‘
â•‘   â€¢ Tout Ã©lÃ©ment NON EXPLICITEMENT AUTORISÃ‰ = INTERDIT                                                â•‘
â•‘   â€¢ Toute AMBIGUÃTÃ‰ = FAIL + demander clarification                                                   â•‘
â•‘   â€¢ Toute HYPOTHÃˆSE = INTERDITE                                                                       â•‘
â•‘   â€¢ Toute ANTICIPATION de phase future = INTERDITE                                                    â•‘
â•‘   â€¢ Toute AMÃ‰LIORATION "bonus" = INTERDITE                                                            â•‘
â•‘   â€¢ Toute DÃ‰VIATION du format de sortie = INTERDITE                                                   â•‘
â•‘                                                                                                       â•‘
â•‘   SI DOUTE â†’ FAIL                                                                                     â•‘
â•‘   SI BLOCAGE FATAL â†’ STOP + rapport + demander Architecte                                             â•‘
â•‘                                                                                                       â•‘
â•šâ•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
```

## Â§0.2 DOCUMENT DE RÃ‰FÃ‰RENCE OBLIGATOIRE

**AVANT TOUTE IMPLÃ‰MENTATION**, lire et appliquer :

```
CANON_SCHEMA_SPEC v1.2.0
SHA-256: 6a6298aed6e50ad86d119a4e876d9119838d65d994a0ba3162cc7a5919eaeac2
```

Ce prompt NE DUPLIQUE PAS la spec. Il dÃ©finit :
- La sÃ©quence d'exÃ©cution
- Les gates de validation
- Le format de sortie
- Les artefacts Ã  produire

**La spec v1.2 est la SOURCE DE VÃ‰RITÃ‰ pour les types, invariants et rÃ¨gles.**

---

## Â§0.3 FORMAT DE SORTIE UNIFIÃ‰ (OBLIGATOIRE)

Chaque gate produit un rapport au format EXACT suivant :

```markdown
# RAPPORT [GATE] â€” [NOM]

## STATUS: [PASS | FAIL | BLOCKED]

## ARTEFACTS CRÃ‰Ã‰S
| Fichier | Lignes | SHA-256 (tronquÃ© 16 chars) |
|---------|--------|----------------------------|
| path/to/file.ts | XXX | XXXXXXXXXXXXXXXX |

## TESTS
| Suite | Total | Pass | Fail | Skip |
|-------|-------|------|------|------|
| canon | XX | XX | 0 | 0 |

## INVARIANTS VÃ‰RIFIÃ‰S
| ID | Description | Status |
|----|-------------|--------|
| INV-E-XXX | Description | âœ…/âŒ |

## GATE VERDICT: [PASS | FAIL]

## ERREURS (si FAIL)
- [Description erreur 1]
```

**AUCUN TEXTE LIBRE HORS DE CE FORMAT.**

---

## Â§0.4 SCOPE LOCK ABSOLU

### Â§0.4.1 ZONE SCELLÃ‰E (INTERDITE EN MODIFICATION)

| Artefact | Status |
|----------|--------|
| `src/memory/**` | ğŸ”’ SEALED |
| `src/sentinel/**` | ğŸ”’ SEALED |
| `src/memory-write-runtime/**` | ğŸ”’ SEALED |
| `src/shared/clock.ts` | ğŸ”’ SEALED (RÃ‰UTILISER) |
| `src/shared/canonical.ts` | ğŸ”’ SEALED (RÃ‰UTILISER) |
| `src/shared/lock.ts` | ğŸ”’ SEALED (RÃ‰UTILISER) |

**INVARIANT INV-E-SCOPE-01** : Aucun diff autorisÃ© sur fichiers SEALED.

### Â§0.4.2 ZONE AUTORISÃ‰E (CRÃ‰ATION/MODIFICATION)

| Chemin | Type | Description |
|--------|------|-------------|
| `src/canon/**` | CREATE | Code Canon Phase E |
| `tests/canon/**` | CREATE | Tests Canon |
| `config/canon/**` | CREATE | Config JSON (symboles runtime) |
| `data/canon/**` | CREATE | Segments canon + manifest |
| `scripts/gate-e*.ts` | CREATE | Scripts gates E |
| `manifests/PHASE_E_*.txt` | CREATE | Manifests Phase E |

---

## Â§0.5 INTERDICTIONS ABSOLUES (8 RÃˆGLES)

**Extrait de CANON_SCHEMA_SPEC v1.2 Â§1.2 â€” Ã€ APPLIQUER STRICTEMENT**

| ID | Interdiction | DÃ©tail |
|----|--------------|--------|
| INT-E-01 | 0 modification zones SEALED | A/B/D/C+CD intouchables |
| INT-E-02 | 0 constante magique | tout = ConfigSymbol |
| INT-E-03 | 0 heuristique/ML | dÃ©tection contradiction = rÃ¨gles strictes |
| INT-E-04 | 0 update/delete | append-only strict |
| INT-E-05 | 0 timestamp wall-clock | dans donnÃ©es hashÃ©es |
| INT-E-06 | 0 Math.random/Date.now | utiliser Clock+RNG injectÃ©s |
| **INT-E-07** | **0 comparaison !== brute** | **utiliser semanticEquals()** |
| **INT-E-08** | **0 valeur NaN** | **Guard FAIL immÃ©diat** |

---

## Â§0.6 RÃˆGLES DE NON-DÃ‰RIVE (22 RÃˆGLES)

| # | RÃ¨gle | Description |
|---|-------|-------------|
| R01 | ExÃ©cution littÃ©rale | Suivre les specs mot Ã  mot |
| R02 | ZÃ©ro interprÃ©tation | Ne jamais "comprendre l'intention" |
| R03 | ZÃ©ro anticipation | Ne jamais implÃ©menter une phase future |
| R04 | ZÃ©ro amÃ©lioration | Ne jamais ajouter de feature non spÃ©cifiÃ©e |
| R05 | ZÃ©ro heuristique | Jamais de ML, scoring, probabilitÃ©s |
| R06 | ZÃ©ro approximation | PASS ou FAIL, jamais "presque" |
| R07 | ZÃ©ro dette | Jamais TODO, FIXME, "Ã  faire plus tard" |
| R08 | ZÃ©ro any | TypeScript strict, jamais `any` |
| R09 | ZÃ©ro ts-ignore | Jamais `@ts-ignore` ou `@ts-expect-error` |
| R10 | ZÃ©ro magic number | Tout nombre = ConfigSymbol |
| R11 | Tests first | Ã‰crire les tests AVANT l'implÃ©mentation |
| R12 | Coverage obligatoire | >90% lines, >85% branches |
| R13 | Format strict | Sortie au format Â§0.3 uniquement |
| R14 | Scope strict | Ne jamais toucher zone SEALED |
| R15 | Hash obligatoire | Tout artefact final = SHA-256 |
| R16 | Determinism obligatoire | MÃªme input = mÃªme output = mÃªme hash |
| R17 | Lock obligatoire | Tout append = lock fichier |
| R18 | Trace obligatoire | Toute dÃ©cision = trace (mÃªme DENY) |
| R19 | ConfigSymbol obligatoire | Toute valeur calibrable = symbole |
| R20 | NaN interdit | NaN dans canon = Guard FAIL |
| **R21** | **semanticEquals obligatoire** | **Jamais !== pour comparer objets/valeurs** |
| **R22** | **SUPERSEDES unique** | **Champ structurel uniquement, pas de prÃ©dicat** |

---

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                    PARTIE I â€” INVARIANTS (RÃ‰FÃ‰RENCE SPEC v1.2)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## Â§1.1 INVARIANTS Ã€ VÃ‰RIFIER (29+ TOTAL)

Les invariants sont **DÃ‰FINIS** dans CANON_SCHEMA_SPEC v1.2.0 Â§4.
Ce prompt les **RÃ‰FÃ‰RENCE** :

### Groupe CONFIG
- INV-E-CONFIG-01: Toute valeur calibrable = ConfigSymbol
- INV-E-CONFIG-02: RÃ©solution dÃ©terministe et testable

### Groupe ID
- INV-E-ID-01: IDs branded + opaques
- INV-E-ID-DET-01: MÃªme (clock, rng, seed) = mÃªme ID
- INV-E-ID-VALID-01: Validation regex stricte via ConfigSymbol

### Groupe CANONICAL
- INV-E-CANONICAL-01: canonicalize() dÃ©terministe
- INV-E-CANONICAL-02: SHA256(canonical) stable
- INV-E-CANONICAL-03: undefined â†’ null

### Groupe SEMANTIC
- INV-E-SEMANTIC-01: semanticEquals via canonical
- INV-E-SEMANTIC-02: GÃ¨re BigInt, objects, null

### Groupe NAN
- INV-E-NAN-01: NaN dÃ©tectÃ© = INVALID_VALUE_NAN

### Groupe PREDICATE
- INV-E-PRED-01 Ã  04: Catalog exhaustif + versionnÃ©

### Groupe EVIDENCE
- INV-E-EVID-01, 02: Regex strict + type valide

### Groupe LINEAGE
- INV-E-LINEAGE-01, 02: Hash parent + vÃ©rification chaÃ®ne

### Groupe SEGMENT
- INV-E-SEG-01 Ã  04: Append-only + rotation + manifest

### Groupe INDEX
- INV-E-IDX-01 Ã  03: Reconstructible + bijection + dÃ©terministe

### Groupe CONFLICT
- INV-E-CONFLICT-01: DÃ©tection CONTR-001/002/003
- INV-E-CONFLICT-02: Guard FAIL = no write
- **INV-E-CONFLICT-DET-03: semanticEquals pour comparaison (jamais !==)**

### Groupe STATUS
- INV-E-STATUS-01, 02: ACTIVE/SUPERSEDED/CONDITIONAL

### Groupe PIPELINE
- INV-E-PIPELINE-01, 02: Guardâ†’Sentinelâ†’Receipt bijection

### Groupe READ
- INV-E-READ-01 Ã  03: Index-based + dÃ©terministe

**Consulter CANON_SCHEMA_SPEC v1.2 pour dÃ©finitions complÃ¨tes.**

---

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                    PARTIE II â€” SÃ‰QUENCE D'EXÃ‰CUTION
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## Â§2.1 WARM-UP CHECKLIST

| # | Check | Commande | Attendu |
|---|-------|----------|---------|
| W1 | Node version | `node --version` | â‰¥18.0.0 |
| W2 | npm version | `npm --version` | â‰¥9.0.0 |
| W3 | TypeScript | `npx tsc --version` | â‰¥5.0.0 |
| W4 | Git clean | `git status --porcelain` | Vide ou contrÃ´lÃ© |
| W5 | Tag CD SEALED | `git tag -l "OMEGA_INTEGRATION_PHASE_CD*"` | Tag prÃ©sent |
| W6 | Tests existants | `npm test` | PASS |
| W7 | Deps installÃ©es | `npm ci` | Exit 0 |
| W8 | Shared utils | `ls src/shared/` | clock.ts, canonical.ts, lock.ts |
| W9 | Spec v1.2 hash | VÃ©rifier SHA-256 | 6a6298ae... |

**Si FAIL â†’ STOP. Ne pas continuer.**

---

## Â§2.2 VÃ‰RIFICATION CD SEALED

**Script** : `scripts/verify-cd-sealed.ts`

```typescript
/**
 * VÃ©rifie que Phase C+D est SEALED avant Phase E
 */
import { execSync } from 'child_process';

const SEALED_PATHS = [
  'src/sentinel/types.ts',
  'src/sentinel/rules.ts',
  'src/sentinel/trace.ts',
  'src/sentinel/api.ts',
  'src/memory-write-runtime/adapter.ts',
  'src/shared/clock.ts',
  'src/shared/canonical.ts',
  'src/shared/lock.ts',
];

function main(): void {
  console.log('=== VERIFY CD SEALED ===');
  
  // Check tag
  const tags = execSync('git tag -l "OMEGA_INTEGRATION_PHASE_CD*"', { encoding: 'utf8' });
  if (!tags.includes('OMEGA_INTEGRATION_PHASE_CD')) {
    console.error('âŒ FAIL: Phase CD tag not found');
    process.exit(1);
  }
  console.log('âœ… CD tag:', tags.trim());
  
  // Check files
  for (const path of SEALED_PATHS) {
    try {
      execSync(`test -f ${path}`);
      console.log(`âœ… ${path}`);
    } catch {
      console.error(`âŒ ${path} missing`);
      process.exit(1);
    }
  }
  
  // Run tests
  try {
    execSync('npm test', { stdio: 'inherit' });
  } catch {
    console.error('âŒ Tests failed');
    process.exit(1);
  }
  
  console.log('\n=== CD SEALED: PASS ===');
}

main();
```

---

## Â§2.3 SÃ‰QUENCE GLOBALE (VERROUILLÃ‰E)

```
â”Œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”
â”‚                         SÃ‰QUENCE D'EXÃ‰CUTION PHASE E                            â”‚
â”œâ”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”¤
â”‚                                                                                 â”‚
â”‚   PHASE 1: FONDATIONS                                                           â”‚
â”‚   â”œâ”€â”€ 1.1 WARM-UP â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚   â”œâ”€â”€ 1.2 VERIFY CD SEALED â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚   â””â”€â”€ 1.3 CREATE CONFIG FILES â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚                                                                                 â”‚
â”‚   PHASE 2: TYPES & FACTORY                                                      â”‚
â”‚   â”œâ”€â”€ 2.1 config-symbol.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚   â”œâ”€â”€ 2.2 types.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚   â”œâ”€â”€ 2.3 id-factory.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚   â”œâ”€â”€ 2.4 semantic-equals.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚   â””â”€â”€ 2.5 GATE E1 â€” SCHEMA MODEL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚                                                                                 â”‚
â”‚   PHASE 3: CATALOG & LINEAGE                                                    â”‚
â”‚   â”œâ”€â”€ 3.1 predicate-catalog.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚   â”œâ”€â”€ 3.2 lineage.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚   â””â”€â”€ 3.3 GATE E2 â€” CATALOG INTEGRITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚                                                                                 â”‚
â”‚   PHASE 4: STORAGE                                                              â”‚
â”‚   â”œâ”€â”€ 4.1 segment-writer.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚   â”œâ”€â”€ 4.2 segment-manifest.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚   â”œâ”€â”€ 4.3 GATE E3 â€” SEGMENT INTEGRITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚   â”œâ”€â”€ 4.4 index-builder.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚   â””â”€â”€ 4.5 GATE E4 â€” INDEX REBUILD â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚                                                                                 â”‚
â”‚   PHASE 5: GUARD & QUERY                                                        â”‚
â”‚   â”œâ”€â”€ 5.1 guard.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚   â”œâ”€â”€ 5.2 GATE E5 â€” CONFLICT DETECTION â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚   â”œâ”€â”€ 5.3 query.ts â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚   â””â”€â”€ 5.4 GATE E6 â€” QUERY DETERMINISM â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚                                                                                 â”‚
â”‚   PHASE 6: INTEGRATION                                                          â”‚
â”‚   â”œâ”€â”€ 6.1 canon-api.ts (faÃ§ade) â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚   â”œâ”€â”€ 6.2 GATE E7 â€” PIPELINE INTEGRITY â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚   â””â”€â”€ 6.3 GATE E-PERF â€” PERFORMANCE â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º PASS/FAIL â”‚
â”‚                                                                                 â”‚
â”‚   PHASE 7: SEAL                                                                 â”‚
â”‚   â”œâ”€â”€ 7.1 SEAL E â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º SEALED    â”‚
â”‚   â””â”€â”€ 7.2 RAPPORT FINAL â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â–º DONE      â”‚
â”‚                                                                                 â”‚
â””â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”€â”˜
```

**RÃˆGLE** : Si Ã©tape FAIL â†’ STOP, corriger, relancer. Jamais sauter.

---

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                    PARTIE III â€” CONFIG FILES (RUNTIME)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## Â§3.1 Fichiers Config (NON SCELLÃ‰S)

**Fichier** : `config/canon/id_config.json`

```json
{
  "ID_RNG_HEX_LEN": 8,
  "ID_FORMAT_REGEX_CLM": "^CLM-[0-9a-f]+-[0-9a-f]{8}$",
  "ID_FORMAT_REGEX_ENT": "^ENT-[0-9a-f]+-[0-9a-f]{8}$",
  "ID_FORMAT_REGEX_EVD": "^EVD-[0-9a-f]+-[0-9a-f]{8}$"
}
```

**Fichier** : `config/canon/segment_config.json`

```json
{
  "SEGMENT_MAX_BYTES": 10000000,
  "SEGMENT_TARGET_BYTES": 8000000,
  "SEGMENT_ROTATE_STRATEGY": "AT_MAX",
  "SEGMENT_PREFIX": "seg-",
  "SEGMENT_EXTENSION": ".ndjson"
}
```

**Fichier** : `config/canon/perf_config.json`

```json
{
  "P95_GETBYID_TARGET_MS": 10,
  "P95_QUERY_TARGET_MS": 100,
  "PERF_SEED_CLAIMS_COUNT": 10000
}
```

**Fichier** : `config/canon/predicate_catalog.json`

```json
{
  "version": "1.0.0",
  "predicates": [
    {
      "id": "IS_A",
      "description": "Entity type classification",
      "subject_type": "ENTITY",
      "object_type": "ENTITY",
      "symmetric": false,
      "transitive": true,
      "introduced_version": 1
    },
    {
      "id": "HAS_NAME",
      "description": "Entity has name",
      "subject_type": "ENTITY",
      "object_type": "PRIMITIVE",
      "symmetric": false,
      "transitive": false,
      "introduced_version": 1
    },
    {
      "id": "HAS_ATTRIBUTE",
      "description": "Entity has attribute value",
      "subject_type": "ENTITY",
      "object_type": "PRIMITIVE",
      "symmetric": false,
      "transitive": false,
      "introduced_version": 1
    },
    {
      "id": "RELATED_TO",
      "description": "Generic relation between entities",
      "subject_type": "ENTITY",
      "object_type": "ENTITY",
      "symmetric": true,
      "transitive": false,
      "introduced_version": 1
    }
  ]
}
```

**âš ï¸ NOTE CRITIQUE**: Le prÃ©dicat `SUPERSEDES` est **ABSENT** du catalog.
La supersession est gÃ©rÃ©e **UNIQUEMENT** par le champ structurel `supersedes` dans `CanonClaim`.
**Raison**: Ã‰viter double source de vÃ©ritÃ© (R22).

---

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                    PARTIE IV â€” MODULES PHASE 2 (TYPES & FACTORY)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## Â§4.1 config-symbol.ts

**Spec complÃ¨te** : CANON_SCHEMA_SPEC v1.2 Â§2

| Export | Type | Description |
|--------|------|-------------|
| `ConfigSymbol<K>` | Type | Wrapper typÃ© pour clÃ© config |
| `ConfigResolver` | Interface | resolve, resolveNumber, resolveString |
| `JsonConfigResolver` | Class | ImplÃ©mentation JSON file |
| `createTestConfigResolver` | Function | Factory pour tests (valeurs inline) |

**Invariants** : INV-E-CONFIG-01, INV-E-CONFIG-02

---

## Â§4.2 types.ts

**Spec complÃ¨te** : CANON_SCHEMA_SPEC v1.2 Â§3

| Export | Type | Description |
|--------|------|-------------|
| `ClaimId`, `EntityId`, `EvidenceId` | Brand<string> | IDs opaques |
| `PredicateType` | Brand<string> | Type prÃ©dicat cataloguÃ© |
| `CanonVersion` | Brand<number> | Version monotonique |
| `ChainHash` | Brand<string> | Hash SHA-256 |
| `MonoNs` | Brand<bigint> | Timestamp nano monotonique |
| `RefId` | Union | EvidenceId \| ClaimId |
| `ClaimStatus` | Union | ACTIVE \| SUPERSEDED \| CONDITIONAL |
| `EvidenceType` | Union | CHAPTER \| NOTE \| DECISION \| EXTERNAL \| CANON_CLAIM |
| `EvidenceRef` | Interface | { type, id, location? } |
| `CanonClaim` | Interface | Claim complet avec supersedes structurel |
| `CanonError` | Class | Erreurs typÃ©es avec codes |

**Invariants** : INV-E-NAN-01, INV-E-STATUS-01, INV-E-STATUS-02

---

## Â§4.3 id-factory.ts

**Spec complÃ¨te** : CANON_SCHEMA_SPEC v1.2 Â§3.2

| Export | Type | Description |
|--------|------|-------------|
| `DeterministicRng` | Interface | nextHex(length) |
| `SeededRng` | Class | LCG implementation dÃ©terministe |
| `IdFactory` | Interface | create*Id, validate*Id |
| `DeterministicIdFactory` | Class | Clock + RNG + ConfigResolver |
| `createTestIdFactory` | Function | Factory pour tests |

**Code clÃ© (ConfigSymbol, pas literal)** :

```typescript
constructor(clock: MonoClock, rng: DeterministicRng, config: ConfigResolver) {
  this.hexLen = config.resolveNumber('ID_RNG_HEX_LEN'); // â† Symbol, pas "8"
  this.clmRegex = new RegExp(config.resolveString('ID_FORMAT_REGEX_CLM'));
  // ...
}
```

**Invariants** : INV-E-ID-01, INV-E-ID-DET-01, INV-E-ID-VALID-01

---

## Â§4.4 semantic-equals.ts

**Spec complÃ¨te** : CANON_SCHEMA_SPEC v1.2 Â§3.8

| Export | Type | Description |
|--------|------|-------------|
| `semanticEquals` | Function | Comparaison via canonicalize |
| `containsNaN` | Function | DÃ©tection NaN rÃ©cursive |

**Code critique** :

```typescript
/**
 * Compare deux valeurs sÃ©mantiquement via canonical JSON.
 * INTERDIT d'utiliser !== directement (INT-E-07).
 */
export function semanticEquals(a: unknown, b: unknown): boolean {
  // Gestion bigint
  if (typeof a === 'bigint' && typeof b === 'bigint') {
    return a === b;
  }
  // Gestion null/undefined
  if (a === null || a === undefined) {
    return b === null || b === undefined;
  }
  if (b === null || b === undefined) {
    return false;
  }
  // Comparaison via canonical
  return canonicalize(a) === canonicalize(b);
}

/**
 * DÃ©tecte NaN rÃ©cursivement dans une structure.
 * NaN = INVALID_VALUE_NAN (INT-E-08).
 */
export function containsNaN(value: unknown): boolean {
  if (typeof value === 'number' && Number.isNaN(value)) {
    return true;
  }
  if (Array.isArray(value)) {
    return value.some(containsNaN);
  }
  if (value !== null && typeof value === 'object') {
    return Object.values(value).some(containsNaN);
  }
  return false;
}
```

**Invariants** : INV-E-SEMANTIC-01, INV-E-SEMANTIC-02, INV-E-NAN-01

---

## Â§4.5 GATE E1 â€” SCHEMA MODEL

### Checklist E1 (Blockers spec v1.2)

| ID | Check | VÃ©rification |
|----|-------|--------------|
| E1-B1 | ZÃ©ro non-dÃ©terminisme | grep -r "Math.random\|crypto.randomUUID\|Date.now" src/canon/ |
| E1-B2 | Canonical + undefinedâ†’null | Golden test E1-GOLD-1 |
| E1-B3 | Types cohÃ©rents | EvidenceRef regex, RefId union |
| E1-B4 | semanticEquals utilisÃ© | grep -r "!==" src/canon/ = 0 pour sÃ©mantique |
| E1-B5 | No magic numbers | grep -rE "[0-9]+" src/canon/ vÃ©rifiÃ© |
| E1-B6 | Supersedes unique | Champ structurel, pas prÃ©dicat |

### Tests E1

| ID | Test | Invariant |
|----|------|-----------|
| E1-T1 | ID determinism (mÃªme clock+rng seed) | INV-E-ID-DET-01 |
| E1-T2 | Config symbols resolution | INV-E-CONFIG-02 |
| E1-T3 | Canonical hash stable | INV-E-CANONICAL-01 |
| E1-T4 | undefined â†’ null | INV-E-CANONICAL-03 |
| E1-T5 | Schema validation (valid/invalid/NaN) | INV-E-NAN-01 |
| E1-T6 | EvidenceRef regex strict | INV-E-EVID-01 |
| E1-T7 | semanticEquals bigint | INV-E-SEMANTIC-02 |
| E1-T8 | containsNaN rÃ©cursif | INV-E-NAN-01 |

### Golden Tests (OBLIGATOIRES)

**E1-GOLD-1 : undefined â†’ null**
```typescript
const obj = { a: undefined, b: 1, c: { d: undefined } };
const expected = '{"a":null,"b":1,"c":{"d":null}}';
expect(canonicalize(obj)).toBe(expected);
```

**E1-GOLD-2 : semanticEquals bigint**
```typescript
expect(semanticEquals(BigInt(123), BigInt(123))).toBe(true);
expect(semanticEquals(BigInt(123), BigInt(456))).toBe(false);
expect(semanticEquals(BigInt(123), 123)).toBe(false); // Types diffÃ©rents
```

**E1-GOLD-3 : containsNaN rÃ©cursif**
```typescript
expect(containsNaN({ a: 1, b: { c: NaN } })).toBe(true);
expect(containsNaN({ a: 1, b: [2, NaN] })).toBe(true);
expect(containsNaN({ a: 1, b: 2 })).toBe(false);
```

**E1-GOLD-4 : Hash stable**
```typescript
const claim = { /* claim complet */ };
const hash1 = sha256(canonicalize(claim));
const hash2 = sha256(canonicalize(claim));
expect(hash1).toBe(hash2); // Toujours identique
```

---

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                    PARTIE V â€” MODULES PHASE 3 (CATALOG & LINEAGE)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## Â§5.1 predicate-catalog.ts

| Export | Type | Description |
|--------|------|-------------|
| `PredicateCatalogEntry` | Interface | DÃ©finition prÃ©dicat |
| `PredicateCatalog` | Interface | Catalog versionnÃ© |
| `loadCatalog` | Function | Charge depuis config |
| `validatePredicate` | Function | VÃ©rifie existence |
| `getCatalogHash` | Function | Hash SHA-256 du catalog |

**Invariants** : INV-E-PRED-01, INV-E-PRED-02, INV-E-PRED-03, INV-E-PRED-04

---

## Â§5.2 lineage.ts

| Export | Type | Description |
|--------|------|-------------|
| `computeLineageHash` | Function | Hash parent via canonical |
| `verifyLineageChain` | Function | VÃ©rifie chaÃ®ne |
| `getParentClaim` | Function | RÃ©cupÃ¨re parent |

**RÃ¨gle** (spec v1.2 Â§3.6) :
- `lineage_hash` = SHA256(canonicalize(parent_claim)) si supersedes
- `lineage_hash` = SHA256("GENESIS") si premier claim

**Invariants** : INV-E-LINEAGE-01, INV-E-LINEAGE-02

---

## Â§5.3 GATE E2 â€” CATALOG INTEGRITY

| ID | Test | Invariant |
|----|------|-----------|
| E2-T1 | Catalog load dÃ©terministe | INV-E-PRED-03 |
| E2-T2 | Unknown predicate = FAIL | INV-E-PRED-01 |
| E2-T3 | Catalog hash stable | INV-E-PRED-03 |
| E2-T4 | Lineage hash computation | INV-E-LINEAGE-01 |
| E2-T5 | Lineage GENESIS | INV-E-LINEAGE-01 |
| E2-T6 | Pas de SUPERSEDES dans catalog | R22 |

---

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                    PARTIE VI â€” MODULES PHASE 4 (STORAGE)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## Â§6.1 segment-writer.ts

| Export | Type | Description |
|--------|------|-------------|
| `SegmentWriter` | Class | Ã‰crit claims NDJSON |
| `appendClaim` | Method | Ajoute (avec lock) |
| `shouldRotate` | Method | Test via ConfigSymbol |
| `rotate` | Method | Ferme + crÃ©e nouveau |

**Utilise** : `src/shared/lock.ts` (SEALED)

**Invariants** : INV-E-SEG-01 Ã  04

---

## Â§6.2 segment-manifest.ts

| Export | Type | Description |
|--------|------|-------------|
| `SegmentManifest` | Interface | Manifest complet |
| `SegmentInfo` | Interface | Info par segment |
| `loadManifest` | Function | Charge |
| `updateManifest` | Function | Met Ã  jour |
| `computeManifestHash` | Function | Hash |

---

## Â§6.3 GATE E3 â€” SEGMENT INTEGRITY

| ID | Test | Invariant |
|----|------|-----------|
| E3-T1 | Rotation Ã  SEGMENT_MAX_BYTES | INV-E-SEG-04 |
| E3-T2 | Manifest hash correct | INV-E-SEG-03 |
| E3-T3 | Segment sealed = immuable | INV-E-SEG-03 |
| E3-T4 | Ordre strict respectÃ© | INV-E-SEG-01 |
| E3-T5 | Append fin uniquement | INV-E-SEG-02 |

---

## Â§6.4 index-builder.ts

| Export | Type | Description |
|--------|------|-------------|
| `ClaimIndex` | Interface | claim_id â†’ offset |
| `buildIndex` | Function | Construit |
| `rebuildIndex` | Function | Reconstruit |
| `getClaimOffset` | Function | Lookup |

**Invariants** : INV-E-IDX-01 Ã  03

---

## Â§6.5 GATE E4 â€” INDEX REBUILD

| ID | Test | Invariant |
|----|------|-----------|
| E4-T1 | Index 100% reconstructible | INV-E-IDX-01 |
| E4-T2 | Bijection claim_id â†” offset | INV-E-IDX-02 |
| E4-T3 | Rebuild dÃ©terministe | INV-E-IDX-03 |
| E4-T4 | Rebuild aprÃ¨s corruption | INV-E-IDX-01 |

---

# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•
#                    PARTIE VII â€” MODULES PHASE 5 (GUARD & QUERY)
# â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•â•

## Â§7.1 guard.ts

| Export | Type | Description |
|--------|------|-------------|
| `CanonGuard` | Class | Validation avant write |
| `validateClaim` | Method | Valide complet |
| `checkNaN` | Method | containsNaN |
| `checkConflict` | Method | CONTR-001/002/003 |
| `checkPredicate` | Method | VÃ©rifie catalog |
| `checkEvidence` | Method | VÃ©rifie EvidenceRef |

### RÃ¨gles de Contradiction (spec v1.2 Â§6)

| ID | RÃ¨gle | DÃ©tection |
|----|-------|-----------|
| CONTR-001 | MÃªme (subject, predicate) + objets diffÃ©rents | **semanticEquals**, pas !== |
| CONTR-002 | EntitÃ© rÃ©fÃ©rencÃ©e manquante | Query existence |
| CONTR-003 | Boucle supersession | DAG validation |

**âš ï¸ CRITIQUE** : CONTR-001 utilise `semanticEquals()` (INV-E-CONFLICT-DET-03)

**Invariants** : INV-E-CONFLICT-01, INV-E-CONFLICT-02, INV-E-CONFLICT-DET-03, INV-E-NAN-01

---

## Â§7.2 GATE E5 â€” CONFLICT DETECTION

| ID | Test | Invariant |
|----|------|-----------|
| E5-T1 | CONTR-001 avec semanticEquals | INV-E-CONFLICT-DET-03 |
| E5-T2 | CONTR-001 objets Ã©quivalents = pas de conflit | INV-E-CONFLICT-DET-03 |
| E5-T3